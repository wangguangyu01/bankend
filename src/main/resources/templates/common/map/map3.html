<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bootdo - 地图</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="favicon.ico">
    <link href="/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/layui.css" rel="stylesheet">
    <link href="/css/style.css?v=4.1.0" rel="stylesheet">
    <link href="http://mapopen.cdn.bcebos.com/github/BMapGLLib/DrawingManager/src/DrawingManager.min.css" rel="stylesheet">
    <style  type="text/css">
        *{ margin:0px;padding:0}
        html,body{height:100%;width: 100%}
        #container{height:calc(100% - 18px);width: 100%;position: relative}
        .maxHeight{
            height: 100%;
        }
        .footBtn{
            text-align: right;
        }
        .search-box{
            position: absolute;
            top: 0;
            left: 0;
            z-index: 555;
        }
        .tangram-suggestion{
            z-index: 555;
        }
        ul li {list-style: none;}
        .info {
            z-index: 999;
            width: auto;
            min-width: 22rem;
            padding: .75rem 1.25rem;
            margin-left: 1.25rem;
            position: fixed;
            top: 1rem;
            background-color: #fff;
            border-radius: .25rem;
            font-size: 14px;
            color: #666;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.5);
        }
        .drawing-panel {
            z-index: 999;
            position: fixed;
            bottom: 3.5rem;
            margin-left: 2.5rem;
            padding-left: 0;
            border-radius: .25rem;
            height: 47px;
            box-shadow: 0 2px 6px 0 rgba(27, 142, 236, 0.5);
        }
        .bmap-btn {
            border-right: 1px solid #d2d2d2;
            float: left;
            width: 64px;
            height: 100%;
            background-image: url(//api.map.baidu.com/library/DrawingManager/1.4/src/bg_drawing_tool.png);
            cursor: pointer;
        }
        .drawing-panel .bmap-marker {
            background-position: -65px 0;
        }
        .drawing-panel .bmap-polyline {
            background-position: -195px 0;
        }
        .drawing-panel .bmap-rectangle {
            background-position: -325px 0;
        }
        .drawing-panel .bmap-polygon {
            background-position: -260px 0;
        }
        .drawing-panel .bmap-circle {
            background-position: -130px 0;
        }
    </style>
    <!--<script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&&type=webgl&ak=您的密钥"></script>-->
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content maxHeight" id="app">
    <div class="row maxHeight">
        <ul class = "drawing-panel">
            <li class="bmap-btn bmap-polygon" disabled="disabled" id="polygon" @click="draw($event,map)"></li>
        </ul>
        <div id="container"></div>
        <div class="search-box">
            <div id="r-result">搜索:<input type="text" id="suggestId" size="20" value="" style="width:150px;" /></div>
            <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
        </div>


        <div class="footBtn">
            <button class="btn btn-primary" @click="createMarker">确定</button>
        </div>
    </div>
</div>

<!-- 全局js -->
<script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=L63VqGA7HKUOLTTVkKCGwMxvdobIyHiy"></script>
<script type="text/javascript" src="http://mapopen.cdn.bcebos.com/github/BMapGLLib/DrawingManager/src/DrawingManager.min.js"></script>
<script src="/js/jquery.min.js?v=2.1.4"></script>
<script src="/js/bootstrap.min.js?v=3.3.6"></script>
<script src="/js/bootstrap-paginator.min.js"></script>
<script src="/js/content.js?v=1.0.0"></script>
<script src="/js/layui.js"></script>
<script src="/js/plugins/clipboard/clipboard.min.js"></script>
<script src="/js/plugins/layer/layer.min.js"></script>
<script src="/js/vue.min.js"></script>

<script th:inline="javascript">
    var points = [[${points}]];
    var brqyList = [[${brqyList}]];
    var app = new Vue({
        el: '#app',
        data: {
            drawingManager:null,
            limit: 12,
            offset: 0,
            total: 0,
            file: '',
            type: '',
            rows: '',
            marker:{},
            map:{},
            points:[],
            flag:true,
        },
        methods: {
            overlaycomplete :function(e){
                var _this = this;
                var overlays = _this.map.getOverlays();
                for(var i=0;i<overlays.length-1;i++){
                    if(overlays[i].mytype && overlays[i].mytype=="self"){
                        _this.map.removeOverlay(overlays[i]);
                    }
                }
//
                _this.points = [];
                e.overlay.mytype="self";
                var path = e.overlay.getPath();//Array<Point> 返回多边型的点数组
                for(var i in path){
                    _this.points.push({
                        lat:path[i].lat,
                        lng:path[i].lng
                    })
                }
                var arr = document.getElementsByClassName('bmap-btn');
                for(var i = 0; i<arr.length; i++) {
                    arr[i].style.backgroundPositionY = '0';
                }
            },
            //开始绘制
            draw:function (e,map,callback) {
                var _this = this;
                if(e.target){
                    e = e.target;
                }
                var arr = document.getElementsByClassName('bmap-btn');
                for(var i = 0; i<arr.length; i++) {
                    arr[i].style.backgroundPositionY = '0';
                }
                e.style.backgroundPositionY = '-52px';
                switch(e.id) {
                    case 'polygon': {
                        var drawingType = BMAP_DRAWING_POLYGON;
                        break;
                    }
                }
                _this.drawingManager.addEventListener('overlaycomplete', _this.overlaycomplete);
                // 进行绘制
                if (_this.drawingManager._isOpen && _this.drawingManager.getDrawingMode() === drawingType) {
                    _this.drawingManager.close();
                } else {
                    _this.drawingManager.setDrawingMode(drawingType);
                    _this.drawingManager.open();
                }
                //  callback();
            },
            /**
             * 添加地图绘制工具
             */
            addDrawTool:function(map){
                var styleOptions = {
                    strokeColor: '#5E87DB',   // 边线颜色
                    fillColor: '#5E87DB',     // 填充颜色。当参数为空时，圆形没有填充颜色
                    strokeWeight: 2,          // 边线宽度，以像素为单位
                    strokeOpacity: 1,         // 边线透明度，取值范围0-1
                    fillOpacity: 0.2          // 填充透明度，取值范围0-1
                };
                var labelOptions = {
                    borderRadius: '2px',
                    background: '#FFFBCC',
                    border: '1px solid #E1E1E1',
                    color: '#703A04',
                    fontSize: '12px',
                    letterSpacing: '0',
                    padding: '5px'
                };
                // 实例化鼠标绘制工具
                var drawingManager = new BMapGLLib.DrawingManager(map, {
                    // isOpen: true,        // 是否开启绘制模式
                    enableCalculate: false, // 绘制是否进行测距测面
                    enableSorption: true,   // 是否开启边界吸附功能
                    sorptiondistance: 20,   // 边界吸附距离
                    circleOptions: styleOptions,     // 圆的样式
                    polylineOptions: styleOptions,   // 线的样式
                    polygonOptions: styleOptions,    // 多边形的样式
                    rectangleOptions: styleOptions,  // 矩形的样式
                    labelOptions: labelOptions,      // label样式
                });

                return drawingManager;
            },
            createMap:function (callback) {
                function G(id) {
                    return document.getElementById(id);
                }

                var _this = this;
                var map = new BMapGL.Map("container");

                // 创建地图实例
//                var point = new BMapGL.Point(116.404, 39.915);
                // 创建点坐标
                map.centerAndZoom('临沂市', 12); // 初始化地图,设置中心点坐标和地图级别
                map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
                _this.drawingManager = _this.addDrawTool(map);
//                _this.draw(document.getElementById("polygon"),map,function () {
//
//                });
                callback(map);
                // 地图搜索poi
                var ac = new BMapGL.Autocomplete(    //建立一个自动完成的对象
                    {"input" : "suggestId"
                        ,"location" : map
                    });

                ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
                    var str = "";
                    var _value = e.fromitem.value;
                    var value = "";
                    if (e.fromitem.index > -1) {
                        value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    }
                    str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

                    value = "";
                    if (e.toitem.index > -1) {
                        _value = e.toitem.value;
                        value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    }
                    str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
                    G("searchResultPanel").innerHTML = str;
                });

                var myValue;
                ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
                    var _value = e.item.value;
                    myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
                    setPlace();
                });

                function setPlace(){
                    map.clearOverlays();    //清除地图上所有覆盖物
                    function myFun(){
                        var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                        map.centerAndZoom(pp, 18);
                        map.addOverlay(new BMapGL.Marker(pp));    //添加标注
                        _this.marker.lng = pp.lng;
                        _this.marker.lat = pp.lat;
                    }
                    var local = new BMapGL.LocalSearch(map, { //智能搜索
                        onSearchComplete: myFun
                    });
                    local.search(myValue);

                }
                // 地图搜索poi =====end
            },
            createMarker:function () {
                if( typeof parent.saveRangeData =='function'){

                    parent.saveRangeData(this.points)
                }
                var index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
                parent.layer.close(index);
            },
        },
        mounted:function () {
            var _this = this;
            this.createMap(function (mapdiv) {
                _this.map = mapdiv;
                if(points && points!=""){
                    var point = points.split(";");
                    var arr = [];
                    for(var i in point){
                        _this.points.push({
                            lat:parseFloat(point[i].split(",")[0]),
                            lng:parseFloat(point[i].split(",")[1])
                        });
                        arr.push( new BMapGL.Point(parseFloat(point[i].split(",")[1]),parseFloat(point[i].split(",")[0])));
                    }
                    var polygon = new BMapGL.Polygon(arr,{
                        strokeColor: 'blue',
                        strokeWeight: 2,
                        strokeOpacity: 0.5
                    });
                    polygon.mytype = "self";
                    mapdiv.addOverlay(polygon)
                }
                for(var j in brqyList){
                    points =  brqyList[j].coordinatesBaidu;
                    var point = points.split(";");
                    var arr = [];
                    for(var i in point){
//                        _this.points.push({
//                            lat:parseFloat(point[i].split(",")[0]),
//                            lng:parseFloat(point[i].split(",")[1])
//                        });
                        arr.push( new BMapGL.Point(parseFloat(point[i].split(",")[1]),parseFloat(point[i].split(",")[0])));
                    }
                    var polygon = new BMapGL.Polygon(arr,{
                        strokeColor: 'red',
                        strokeWeight: 2,
                        strokeOpacity: 0.5
                    });
                    polygon.mytype = "other";
                    polygon.datainfo = brqyList[j];
                    polygon.addEventListener("mouseover",function (e) {
                        var point = new BMapGL.Point(e.latLng.lng, e.latLng.lat);
                        var opts = {
                            width: 200,
                            height: 100,
                            title: '详情信息'
                        };
                        console.log(e);
                        var infoWindow = new BMapGL.InfoWindow(e.target.datainfo.type, opts);
                        infoWindow.mytype="window";
                        mapdiv.openInfoWindow(infoWindow, point);
                    });
                    polygon.addEventListener("click",function (e) {
                        console.log(e.latLng.lng, e.latLng.lat)
                    });
                    mapdiv.addOverlay(polygon)
                }
            });
        }
    });
</script>
<script type="text/javascript">

</script>
</body>
</html>
