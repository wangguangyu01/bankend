<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bootdo - 地图</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="favicon.ico">
    <link href="/css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="/css/animate.css" rel="stylesheet">
    <link href="/css/layui.css" rel="stylesheet">
    <link href="/css/style.css?v=4.1.0" rel="stylesheet">
    <style  type="text/css">
        *{ margin:0px;padding:0}
        html,body{height:100%;width: 100%}
        #container{height:calc(100% - 18px);width: 100%;position: relative}
        .maxHeight{
            height: 100%;
        }
        .footBtn{
            text-align: right;
        }
        .search-box{
            position: absolute;
            top: 0;
            left: 0;
            z-index: 555;
        }
        .tangram-suggestion{
            z-index: 555;
        }
    </style>
    <!--<script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&&type=webgl&ak=您的密钥"></script>-->
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content maxHeight" id="app">
    <div class="row maxHeight">
        <div id="container">

        </div>
        <div class="search-box">
            <div id="r-result">搜索:<input type="text" id="suggestId" size="20" value="" style="width:150px;" /></div>
            <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
        </div>


        <div class="footBtn">
            <button class="btn btn-primary" @click="createMarker">确定</button>
        </div>
    </div>
</div>

<!-- 全局js -->
<script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=L63VqGA7HKUOLTTVkKCGwMxvdobIyHiy"></script>
<script src="/js/jquery.min.js?v=2.1.4"></script>
<script src="/js/bootstrap.min.js?v=3.3.6"></script>
<script src="/js/bootstrap-paginator.min.js"></script>
<script src="/js/content.js?v=1.0.0"></script>
<script src="/js/layui.js"></script>
<script src="/js/plugins/clipboard/clipboard.min.js"></script>
<script src="/js/plugins/layer/layer.min.js"></script>
<script src="/js/vue.min.js"></script>

<script th:inline="javascript">
    var lat = [[${lat}]];
    var lng = [[${lng}]];

    var app = new Vue({
        el: '#app',
        data: {
            limit: 12,
            offset: 0,
            total: 0,
            file: '',
            type: '',
            rows: '',
            marker:{}
        },
        methods: {

            createMap:function () {
                function G(id) {
                    return document.getElementById(id);
                }

                var _this = this;
                var map = new BMapGL.Map("container");
                // 创建地图实例
//                var point = new BMapGL.Point(116.404, 39.915);
                // 创建点坐标
                map.centerAndZoom('临沂市', 12); // 初始化地图,设置中心点坐标和地图级别
                map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
                if(lat!=''&& lng!=''){
                    this.initMarker(map);
                }
                // 初始化地图，设置中心点坐标和地图级别
                map.addEventListener('click', function(e) {
                    _this.marker = {};
                    map.clearOverlays()
                    var point = new BMapGL.Point(e.latlng.lng,e.latlng.lat);
                    var marker = new BMapGL.Marker(point);        // 创建标注
                    map.addOverlay(marker);                     // 将标注添加到地图中
                    _this.marker.lng = e.latlng.lng;
                    _this.marker.lat = e.latlng.lat;
                });

                // G(container).innerHTML = "<div id=\"r-result\">搜索:<input type=\"text\" id=\"suggestId\" size=\"20\" value=\"\" style=\"width:150px;\" /></div>\n" +
                //     "            <div id=\"searchResultPanel\" style=\"border:1px solid #C0C0C0;width:150px;height:auto; display:none;\"></div>"

                // 地图搜索poi
                var ac = new BMapGL.Autocomplete(    //建立一个自动完成的对象
                    {"input" : "suggestId"
                        ,"location" : map
                    });

                ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
                    var str = "";
                    var _value = e.fromitem.value;
                    var value = "";
                    if (e.fromitem.index > -1) {
                        value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    }
                    str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

                    value = "";
                    if (e.toitem.index > -1) {
                        _value = e.toitem.value;
                        value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    }
                    str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
                    G("searchResultPanel").innerHTML = str;
                });

                var myValue;
                ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
                    var _value = e.item.value;
                    myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
                    G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;

                    setPlace();
                });

                function setPlace(){
                    map.clearOverlays();    //清除地图上所有覆盖物
                    function myFun(){
                        var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                        map.centerAndZoom(pp, 18);
                        map.addOverlay(new BMapGL.Marker(pp));    //添加标注
                        _this.marker.lng = pp.lng;
                        _this.marker.lat = pp.lat;
                    }
                    var local = new BMapGL.LocalSearch(map, { //智能搜索
                        onSearchComplete: myFun
                    });
                    local.search(myValue);
                }
                // 地图搜索poi =====end
            },
            createMarker:function () {
                if( typeof parent.saveMarker =='function'){
                    parent.saveMarker(this.marker.lng,this.marker.lat);
                }
                var index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
                parent.layer.close(index);
            },
            initMarker:function (map) {
                var point = new BMapGL.Point(lng,lat);
                var marker = new BMapGL.Marker(point);
                map.addOverlay(marker);
            },



        },
        mounted:function () {
            this.createMap();

        }
    });
</script>
<script type="text/javascript">

</script>
</body>
</html>
